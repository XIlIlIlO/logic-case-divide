<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê±°ë˜ë¡œì§ ë¶„ì„ ë„êµ¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 0;
        }
        
        header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #1e8449 0%, #16a085 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .left-panel {
            grid-column: 1;
            grid-row: 2;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            padding: 15px;
        }
        
        .main-content {
            grid-column: 2;
            grid-row: 2;
            background: white;
            overflow-y: auto;
            padding: 20px;
        }
        
        footer {
            grid-column: 1 / -1;
            background: #f9f9f9;
            border-top: 1px solid #e0e0e0;
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .logic-group {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        
        .logic-group-header {
            background: #e8f4f8;
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .logic-group-header:hover {
            background: #d4ebf0;
        }
        
        .logic-group-title {
            font-weight: 600;
            font-size: 14px;
            color: #1e8449;
        }
        
        .logic-group-subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .toggle-icon {
            display: inline-block;
            transition: transform 0.3s;
        }
        
        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        
        .logic-group-content {
            padding: 12px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .logic-group-content.hidden {
            display: none;
        }
        
        .file-item {
            background: white;
            padding: 8px 10px;
            margin-bottom: 6px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        
        .file-name {
            flex: 1;
            word-break: break-all;
            color: #555;
        }
        
        .btn-small {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .btn-small:hover {
            background: #ff5252;
        }
        
        .btn-add-file {
            display: none;
        }
        
        .logic-group-content input[type="file"] {
            font-size: 12px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .controls-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .control-group input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
        
        .control-group input[type="number"] {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 100px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            border: 1px solid #ddd;
        }
        
        th {
            background: #1e8449;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #155a3a;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .highlight {
            background: #E8F5E9 !important;
        }
        
        .btn-primary {
            background: #1e8449;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-primary:hover {
            background: #16a085;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .btn-secondary {
            background: #666;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        .left-panel-header {
            font-weight: 600;
            font-size: 14px;
            color: #1e8449;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #1e8449;
        }
        
        .add-logic-group-btn {
            width: 100%;
            background: #1e8449;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .add-logic-group-btn:hover {
            background: #16a085;
        }
        
        .delete-logic-group {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .delete-logic-group:hover {
            background: #ff5252;
        }
        
        .logic-group-header-controls {
            display: flex;
            gap: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š ê±°ë˜ë¡œì§ ë¶„ì„ ë„êµ¬</h1>
        </header>
        
        <div class="left-panel">
            <div class="left-panel-header">ë¡œì§ ì§‘ë‹¨</div>
            <button class="add-logic-group-btn" onclick="addLogicGroup()">+ ë¡œì§ ì§‘ë‹¨ ì¶”ê°€</button>
            <div id="logicGroupsContainer"></div>
        </div>
        
        <div class="main-content">
            <div class="controls-section">
                <h3 style="margin-bottom: 12px; color: #1e8449;">í•„í„°ë§ ì¡°ê±´</h3>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="filterStopLoss" onchange="applyFilters()">
                        ì†ì ˆíšŸìˆ˜ n ì´í•˜
                    </label>
                    <input type="number" id="stopLossThreshold" placeholder="n ì…ë ¥" value="0" min="0" onchange="applyFilters()" disabled>
                </div>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="filterPositiveProfit" onchange="applyFilters()">
                        ìˆœì´ìµì´ ì–‘ìˆ˜
                    </label>
                </div>
                
                <div class="btn-group">
                    <button class="btn-secondary" onclick="clearAllFilters()">í•„í„° ì´ˆê¸°í™”</button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>ê·¸ë£¹ëª…</th>
                            <th>ìµì ˆê¸ˆì•¡</th>
                            <th>ì†ì ˆê¸ˆì•¡</th>
                            <th>ìˆ˜ìˆ˜ë£Œ</th>
                            <th>í™•ì •ì†ìµê¸ˆ</th>
                            <th>ë¯¸ì‹¤í˜„ì†ìµ</th>
                            <th>ìˆœì´ìµ</th>
                            <th>ìµì ˆíšŸìˆ˜</th>
                            <th>ì†ì ˆíšŸìˆ˜</th>
                            <th>ìŠ¹ë¥ </th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody">
                        <tr><td colspan="10" style="text-align: center; color: #999;">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer>
            <button class="btn-primary" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn-primary" onclick="clearAllData()" style="background: #ff6b6b;">ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
        </footer>
    </div>

    <script>
        let logicGroups = [];
        let allData = [];
        
        // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë³µì›
        function loadFromStorage() {
            const saved = localStorage.getItem('logicGroups');
            if (saved) {
                logicGroups = JSON.parse(saved);
                renderLogicGroups();
            } else {
                addLogicGroup();
            }
        }
        
        function saveToStorage() {
            localStorage.setItem('logicGroups', JSON.stringify(logicGroups));
        }
        
        function addLogicGroup() {
            const groupId = Date.now();
            logicGroups.push({
                id: groupId,
                name: `ë¡œì§${logicGroups.length + 1}`,
                subtitle: '313 - 15%',
                files: [],
                isCollapsed: false
            });
            saveToStorage();
            renderLogicGroups();
        }
        
        function deleteLogicGroup(groupId) {
            if (confirm('ì´ ë¡œì§ ì§‘ë‹¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                logicGroups = logicGroups.filter(g => g.id !== groupId);
                saveToStorage();
                renderLogicGroups();
                applyFilters();
            }
        }
        
        function renderLogicGroups() {
            const container = document.getElementById('logicGroupsContainer');
            container.innerHTML = '';
            
            logicGroups.forEach((group, index) => {
                const groupHtml = `
                    <div class="logic-group" data-group-id="${group.id}">
                        <div class="logic-group-header" onclick="toggleLogicGroup(${group.id})">
                            <div>
                                <div class="logic-group-title">
                                    <span class="toggle-icon ${group.isCollapsed ? 'collapsed' : ''}">â–¼</span>
                                    ${group.name}
                                </div>
                                <div class="logic-group-subtitle">${group.subtitle}</div>
                            </div>
                            <div class="logic-group-header-controls">
                                <button class="delete-logic-group" onclick="event.stopPropagation(); deleteLogicGroup(${group.id})">ì‚­ì œ</button>
                            </div>
                        </div>
                        <div class="logic-group-content ${group.isCollapsed ? 'hidden' : ''}">
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 11px; color: #666;">ë¡œì§ ì´ë¦„:</label>
                                <input type="text" value="${group.name}" onchange="updateGroupName(${group.id}, this.value)" 
                                       style="width: 100%; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 11px; color: #666;">ë¶€ì œëª© (ì˜ˆ: 313 - 15%):</label>
                                <input type="text" value="${group.subtitle}" onchange="updateGroupSubtitle(${group.id}, this.value)" 
                                       style="width: 100%; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 8px;">
                                <input type="file" accept=".xlsx,.xls,.csv" multiple onchange="addFilesToGroup(${group.id}, event)">
                            </div>
                            <div id="files-${group.id}">
                                ${group.files.map((file, idx) => `
                                    <div class="file-item">
                                        <span class="file-name">${file.name}</span>
                                        <button class="btn-small" onclick="removeFileFromGroup(${group.id}, ${idx})">ì œê±°</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += groupHtml;
            });
        }
        
        function toggleLogicGroup(groupId) {
            const group = logicGroups.find(g => g.id === groupId);
            if (group) {
                group.isCollapsed = !group.isCollapsed;
                saveToStorage();
                renderLogicGroups();
            }
        }
        
        function updateGroupName(groupId, newName) {
            const group = logicGroups.find(g => g.id === groupId);
            if (group) {
                group.name = newName || `ë¡œì§${logicGroups.indexOf(group) + 1}`;
                saveToStorage();
                renderLogicGroups();
                applyFilters();
            }
        }
        
        function updateGroupSubtitle(groupId, newSubtitle) {
            const group = logicGroups.find(g => g.id === groupId);
            if (group) {
                group.subtitle = newSubtitle;
                saveToStorage();
                renderLogicGroups();
            }
        }
        
        function addFilesToGroup(groupId, event) {
            const group = logicGroups.find(g => g.id === groupId);
            if (!group) return;
            
            const files = Array.from(event.target.files);
            const promises = files.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const data = XLSX.utils.sheet_to_json(workbook.Sheets['Total_Result']);
                            group.files.push({
                                name: file.name,
                                data: data
                            });
                            resolve();
                        } catch (err) {
                            alert(`íŒŒì¼ ${file.name} ì½ê¸° ì‹¤íŒ¨: ${err.message}`);
                            resolve();
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            });
            
            Promise.all(promises).then(() => {
                saveToStorage();
                renderLogicGroups();
                applyFilters();
            });
            
            event.target.value = '';
        }
        
        function removeFileFromGroup(groupId, fileIndex) {
            const group = logicGroups.find(g => g.id === groupId);
            if (group) {
                group.files.splice(fileIndex, 1);
                saveToStorage();
                renderLogicGroups();
                applyFilters();
            }
        }
        
        function mergeGroupData() {
            allData = [];
            
            logicGroups.forEach(group => {
                const groupData = {};
                
                group.files.forEach(file => {
                    file.data.forEach(row => {
                        const groupName = row['Group Name'];
                        if (groupName) {
                            if (!groupData[groupName]) {
                                groupData[groupName] = { ...row };
                            } else {
                                // ì¤‘ë³µë˜ë©´ ìˆ«ìë“¤ì„ ë”í•¨
                                const keys = ['ìµì ˆê¸ˆì•¡', 'ì†ì ˆê¸ˆì•¡', 'ìˆ˜ìˆ˜ë£Œ', 'í™•ì •ì†ìµê¸ˆ', 'ë¯¸ì‹¤í˜„ì†ìµ', 'ìˆœì´ìµ', 'ìµì ˆíšŸìˆ˜', 'ì†ì ˆíšŸìˆ˜'];
                                keys.forEach(key => {
                                    groupData[groupName][key] = (parseFloat(groupData[groupName][key]) || 0) + (parseFloat(row[key]) || 0);
                                });
                            }
                        }
                    });
                });
                
                Object.entries(groupData).forEach(([name, data]) => {
                    allData.push({
                        ...data,
                        logicGroup: group.name,
                        logicId: group.id
                    });
                });
            });
        }
        
        function applyFilters() {
            mergeGroupData();
            const filterStopLoss = document.getElementById('filterStopLoss').checked;
            const filterPositiveProfit = document.getElementById('filterPositiveProfit').checked;
            const stopLossThreshold = parseInt(document.getElementById('stopLossThreshold').value) || 0;
            
            document.getElementById('stopLossThreshold').disabled = !filterStopLoss;
            
            const tbody = document.getElementById('resultTableBody');
            if (allData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = allData.map((row, idx) => {
                const stopLossCount = parseFloat(row['ì†ì ˆíšŸìˆ˜']) || 0;
                const netProfit = parseFloat(row['ìˆœì´ìµ']) || 0;
                
                let highlightStopLoss = filterStopLoss && stopLossCount <= stopLossThreshold;
                let highlightProfit = filterPositiveProfit && netProfit > 0;
                let shouldHighlight = (filterStopLoss && highlightStopLoss) || (filterPositiveProfit && highlightProfit);
                
                return `
                    <tr>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${row['Group Name'] || ''}</td>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${(parseFloat(row['ìµì ˆê¸ˆì•¡']) || 0).toFixed(2)}</td>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${(parseFloat(row['ì†ì ˆê¸ˆì•¡']) || 0).toFixed(2)}</td>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${(parseFloat(row['ìˆ˜ìˆ˜ë£Œ']) || 0).toFixed(2)}</td>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${(parseFloat(row['í™•ì •ì†ìµê¸ˆ']) || 0).toFixed(2)}</td>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${(parseFloat(row['ë¯¸ì‹¤í˜„ì†ìµ']) || 0).toFixed(2)}</td>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${(parseFloat(row['ìˆœì´ìµ']) || 0).toFixed(2)}</td>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${Math.round(parseFloat(row['ìµì ˆíšŸìˆ˜']) || 0)}</td>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${Math.round(parseFloat(row['ì†ì ˆíšŸìˆ˜']) || 0)}</td>
                        <td class="${shouldHighlight ? 'highlight' : ''}">${row['ìŠ¹ë¥ '] || ''}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function clearAllFilters() {
            document.getElementById('filterStopLoss').checked = false;
            document.getElementById('filterPositiveProfit').checked = false;
            document.getElementById('stopLossThreshold').value = '0';
            applyFilters();
        }
        
        function downloadExcel() {
            if (allData.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const headers = ['ê·¸ë£¹ëª…', 'ìµì ˆê¸ˆì•¡', 'ì†ì ˆê¸ˆì•¡', 'ìˆ˜ìˆ˜ë£Œ', 'í™•ì •ì†ìµê¸ˆ', 'ë¯¸ì‹¤í˜„ì†ìµ', 'ìˆœì´ìµ', 'ìµì ˆíšŸìˆ˜', 'ì†ì ˆíšŸìˆ˜', 'ìŠ¹ë¥ '];
            const rows = allData.map(row => [
                row['Group Name'] || '',
                (parseFloat(row['ìµì ˆê¸ˆì•¡']) || 0).toFixed(2),
                (parseFloat(row['ì†ì ˆê¸ˆì•¡']) || 0).toFixed(2),
                (parseFloat(row['ìˆ˜ìˆ˜ë£Œ']) || 0).toFixed(2),
                (parseFloat(row['í™•ì •ì†ìµê¸ˆ']) || 0).toFixed(2),
                (parseFloat(row['ë¯¸ì‹¤í˜„ì†ìµ']) || 0).toFixed(2),
                (parseFloat(row['ìˆœì´ìµ']) || 0).toFixed(2),
                Math.round(parseFloat(row['ìµì ˆíšŸìˆ˜']) || 0),
                Math.round(parseFloat(row['ì†ì ˆíšŸìˆ˜']) || 0),
                row['ìŠ¹ë¥ '] || ''
            ]);
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            
            ws['!cols'] = [
                { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 12 },
                { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 10 },
                { wch: 10 }, { wch: 10 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ë¶„ì„ê²°ê³¼');
            XLSX.writeFile(wb, `ê±°ë˜ë¶„ì„_${new Date().getTime()}.xlsx`);
        }
        
        function clearAllData() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                logicGroups = [];
                allData = [];
                localStorage.clear();
                location.reload();
            }
        }
        
        // ì´ˆê¸° ë¡œë“œ
        window.addEventListener('load', loadFromStorage);
    </script>
</body>
</html>
